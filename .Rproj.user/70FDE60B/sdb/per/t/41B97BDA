{
    "contents" : "\n\n\n```{r,echo=FALSE,message=FALSE,error=FALSE,eval=TRUE}\nlibrary(rvest)\nlibrary(RCurl)\nlibrary(XML)\nlibrary(knitr)\nopts_knit$set(cache=T,eval=T,echo=T)\n```\n\n# 首页概览\n\n```{r,opts}\nwangyistock=\"http://quotes.money.163.com/f10/zcfzb_\"\nstockNO=\"600000\"\npage=\"01c05\"\nurl=paste(wangyistock,stockNO,\".html#\",page,sep = \"\")\n```\n\n```{r}\npage=\"01c05\"\nurl=paste(wangyistock,stockNO,\".html#\",page,sep = \"\")\n#K线图\nweb=read_html(url,encoding=\"utf-8\")\npic=web %>%  html_nodes(\"#altcontentts\") %>% html_text() #项目\n\n```\n# 资金流向\n\n### 历史交易数据\n```{r}\nurl=\"http://quotes.money.163.com/trade/lsjysj_\"\nyear=rep(x = c(2014:2015),each=4)\nseason=rep(x=(1:4),each=1,times=2)\nhistory_trade=function(url=url,stockNO=\"600000\",year=year,season=season,path)\n        {\n        time=cbind(year,season)\n        #his_trade=data.frame(NA)\n        stockNO=as.character(stockNO)\n        for(i in 1:nrow(time)){\n        web=paste(url,stockNO,\".html?year=\",time[i,1],\"&season=\",time[i,2],sep=\"\")\n        data=getURL(web,.encoding = \"utf-8\")\n        tab=readHTMLTable(doc =data,header = T,colClasses = \"character\", trim=T, stringsAsFactors = FALSE)\n        tmp=tab[[4]]\n        colnames(tmp)=tmp[1,]\n        tmp=tmp[-1,]\n        #his_trade[[i]]=tmp\n        if(i==1){\n                his_trade=tmp\n        }else{\n                his_trade=rbind(his_trade,tmp)\n        }\n        }\n\n       return(his_trade) \n}\na=history_trade()\n\n```\n\n\n### 历史资金流向\n```{r,captial_flow}\nweb=\"http://quotes.money.163.com/trade/lszjlx_\"\ncapital_flow=function(url=web,stockNO=\"600000\",page=c(0:5),path){\n        stockNO=as.character(stockNO)\n        for(i in page){\n        web=paste(url,stockNO,\",\",i,\".html\",sep=\"\")\n        data=getURL(web,.encoding = \"utf-8\")\n        tab=readHTMLTable(doc =data,header = T,colClasses = \"character\", trim=T, stringsAsFactors = FALSE)\n        tmp=tab[[4]]\n        colnames(tmp)=tmp[1,]\n        tmp=tmp[-1,]\n        #his_trade[[i]]=tmp\n        if(i==0){\n                capital_flow=tmp\n        }else{\n                capital_flow=rbind(capital_flow,tmp)\n        }\n        }\n\n       return(capital_flow) \n}\na=capital_flow()\n```\n\n\n\nrequire(rJava)\n.jinit()\njRobot <- .jnew(\"java/awt/Robot\")\npressButton<-function() {\n   jRobot$mousePress(J(\"java/awt/event/InputEvent\")$BUTTON1_MASK)\n   jRobot$mouseRelease(J(\"java/awt/event/InputEvent\")$BUTTON1_MASK)\n}\npressButton()\n\n```{r}\n\nurl=\"http://quotes.money.163.com/f10/zcfzb_601668.html#01c05\"\nweb=read_html(url,encoding=\"UTF-8\")\npro=web %>%  html_nodes(\".td_1\") %>% html_text() #项目\npro=iconv(pro,'utf-8','gbk') #乱码，转换输出格式\nt=web %>%  html_nodes(\".scr_table td:nth-child(1)\") %>% html_text()\ntablehead=web %>%  html_nodes(\"th\") %>% html_text()\ntablehead=iconv(tablehead,'utf-8','gbk') \ntab=web %>%  html_nodes(\".scr_table td\") %>% html_text()\n```\n这样操作的话合并表格时很复杂的，改用XML\n## 用XML和getURL\n```{r}\nurl=\"http://quotes.money.163.com/f10/zcfzb_601668.html#01c05\"\ndoc=xmlTreeParse(url,useInternal=TRUE) #报错，有未闭合的标签\ndata=getURL(url,.encoding = \"utf-8\")\ntab=readHTMLTable(doc =data,header = T,colClasses = NULL, trim=T)\ndf=cbind(tab[[4]][-1,],tab[[5]])\n```\n\n\n\n\n#公司简介\n```{r}\nurl=\"http://quotes.money.163.com/f10/gszl_\"\ncompany_intro=function(){\n        web=paste(url,stockNO,\".html#01f02\")\n        webpage=getURL(url = web,.encoding = \"utf-8\")\n        data=readHTMLTable(doc = webpage,header = T,colClasses = \"character\", trim=T, stringsAsFactors = FALSE)\n        \n        #公司基本信息\n        ComIntro=data[[4]]\n        colnames(ComIntro)=c(\"value\",\"name\",\"value\",\"name\")\n        ComIntro=rbind(ComIntro[,c(1,2)],ComIntro[,c(3,4)])\n        ComIntro=ComIntro[complete.cases(ComIntro),]\n        #业务收入比例\n        Bus_scale=data[[7]]\n        colnames(Bus_scale)=Bus_scale[1,]\n        Bus_scale=Bus_scale[-1,]\n}\nurl=\"http://quotes.money.163.com/f10/gszl_601668.html#01f02\"\nComIntro=getURL(url,.encoding = \"utf-8\")\ntab=readHTMLTable(doc =ComIntro,header = T,colClasses = \"character\", trim=T, stringsAsFactors = FALSE)\n\n#资产负债表\n\n```\n\n\n\n#模拟鼠标点击界面里\"下载数据\"这个功能\n#实际上就是跳入到\"http://quotes.money.163.com/service/zcfzb_601668.html\"这个页面\nx=web %>%  html_nodes(\"#downloadData\") %>% html_text() #项目\niconv(x,\"utf-8\",\"gbk\") #只返回“下载数据”这几个字\n\nurl=\"http://quotes.money.163.com/service/zcfzb_601668.html\"\nweb=read_html(url,encoding=\"utf-8\")\n\n\n",
    "created" : 1448593884550.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "63|19|85|3|\n98|6|108|3|\n",
    "hash" : "1576893582",
    "id" : "41B97BDA",
    "lastKnownWriteTime" : 1448889789,
    "path" : "D:/Git/stock/163stock.Rmd",
    "project_path" : "163stock.Rmd",
    "properties" : {
        "tempName" : "Untitled2"
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}