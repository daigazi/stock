{
    "contents" : "#读入沪深两市所有上市公司名称及其股票代码。\nSys.setenv(JAVA_HOME='C:\\\\Program Files\\\\Java\\\\jdk1.8.0_25\\\\jre');\nsetwd(\"D:\\\\Rwork\")\nlibrary(rJava)\nlibrary(xlsx)\nstockid=read.xlsx(\"C:\\\\Users\\\\dai_jl\\\\Desktop\\\\沪深股票名单.xlsx\",\n                  sheetIndex=1,header=T,colClasses=c(\"character\",\"character\"),encoding=\"UTF-8\")\ncolnames(stockid)=c(\"ID\",\"Company\")\nstockid$ID=as.character(stockid$ID)\na0=\"\";a1=\"0\";a2=\"00\";a3=\"000\";a4=\"0000\";a5=\"00000\";a6=\"000000\"\na=c(a0,a1,a2,a3,a4,a5,a6)\nlibrary(XML)\n# 从网页上抓取数据，并进行清理\n  Lsummary_finance=list() #财务报表分析摘要\nfor(i in 1:nrow(stockid[1:5,])){\n  l=nchar(stockid$ID[i])\n  A=a[6-l+1]\n  ID=paste(A,stockid$ID[i],sep=\"\")\n  url1=paste(\"http://quotes.money.163.com/f10/zycwzb_\",ID,\".html#01c02\",sep=\"\")\n  url2=paste(\"http://quotes.money.163.com/f10/zycwzb_\",ID,\".html#01c03\",sep=\"\")\n  url3=paste(\"http://quotes.money.163.com/f10/zycwzb_\",ID,\".html#01c04\",sep=\"\")\n  url4=paste(\"http://quotes.money.163.com/f10/zycwzb_\",ID,\".html#01c05\",sep=\"\")\n  url5=paste(\"http://quotes.money.163.com/f10/zycwzb_\",ID,\".html#01c06\",sep=\"\")\n  url6=paste(\"http://quotes.money.163.com/f10/zycwzb_\",ID,\".html#01c07\",sep=\"\")\n  \n  #主要财务分析\n # url1 <-'http://quotes.money.163.com/f10/zycwzb_600000.html#01c02' \n  tables1 <- readHTMLTable(url1,stringsAsFactors = FALSE)\n  Netprofit=cbind(tables1[[4]],tables1[[5]]) #净利润\n  Profitability=tables1[[6]]  #盈利能力\n  repay=tables1[[7]]      #偿还能力\n  growth=tables1[[8]]     #成长能力\n  operation=tables1[[9]]  #营运能力\n  #财务报表摘要\n  #url2 <-'http://quotes.money.163.com/f10/cwbbzy_600000.html#01c04' \n  tables2 <- readHTMLTable(url2,stringsAsFactors = FALSE)\n if(nrow(tables2[[4]])==nrow(tables2[[5]])+1){\n   summary_finance=cbind(tables2[[4]][-1,1],tables2[[5]]) ##财务报表摘要\n }else{\n   summary_finance=cbind(tables2[[4]],tables2[[5]]) ##财务报表摘要\n }\n  #summary_finance=cbind(tables2[[4]][-1,1],tables2[[5]]) #财务报表摘要\n  colnames(summary_finance)[1]=\"报告日期\"\n Lsummary_finance=[[i]]=summary_finance\n  names(Lsummary_finance=)[i]=ID\n  #资产负债表\n  #url3 <-'http://quotes.money.163.com/f10/zcfzb_600000.html#01c05' \n  tables3 <- readHTMLTable(url3,stringsAsFactors = FALSE)\n  if(nrow(tables3[[4]])==nrow(tables3[[5]])+1){\n    balance=cbind(tables3[[4]][-1,1],tables3[[5]]) #资产负债表\n  }\n  else{\n    balance=cbind(tables3[[4]],tables3[[5]]) #资产负债表\n  }\n  colnames(balance)[1]=\"报告日期\"\n  \n  \n  #利润表\n #url4 <-'http://quotes.money.163.com/f10/zcfzb_600000.html#01c06' \n  tables4 <- readHTMLTable(url3,stringsAsFactors = FALSE)\nif(nrow(tables4[[4]])==nrow(tables4[[5]])+1){\n  profit=cbind(tables4[[4]][-1,1],tables4[[5]]) #利润表\n}\nelse{\n  profit=cbind(tables4[[4]],tables4[[5]]) #利润表\n}\n  #profit=cbind(tables4[[4]][-1,1],tables4[[5]]) #利润表\n  colnames(profit)[1]=\"报告日期\"\n  \n  #现金流量表\n # url5 <-'http://quotes.money.163.com/f10/zcfzb_600000.html#01c07' \n  tables5 <- readHTMLTable(url3,stringsAsFactors = FALSE)\nif(nrow(tables5[[4]])==nrow(tables5[[5]])+1){\n  cash=cbind(tables5[[4]][-1,1],tables5[[5]]) #现金流量表\n}\nelse{\n  cash=cbind(tables5[[4]],tables5[[5]]) #现金流量表\n}\n\n  #cash=cbind(tables5[[4]][-1,1],tables5[[5]]) #现金流量表\n  colnames(cash)[1]=\"报告日期\"\n\n\n #最后创建一个文件夹，把一只股票的先关表格存在每个文件夹下\n\n dirs=list.dirs(getwd())\nif(length(which(dirs==paste(getwd(),\"/\",ID,sep=\"\")))==0){\n  dir.create(ID)  #新建文件夹\n}\n  write.xlsx(cash,paste(\"D:\\\\Rwork\\\\\",ID,\"\\\\cash.xlsx\",sep=\"\"))   \n write.xlsx( balance,paste(\"D:\\\\Rwork\\\\\",ID,\"\\\\balance.xlsx\",sep=\"\"))  \n write.xlsx(profit,paste(\"D:\\\\Rwork\\\\\",ID,\"\\\\profit.xlsx\",sep=\"\"))  \n  Sys.sleep(time = 1) #1秒\n}\n\n\n\n\n\n#主要财务分析\nurl1 <-'http://quotes.money.163.com/f10/zycwzb_600000.html#01c02' \ntables1 <- readHTMLTable(url1,stringsAsFactors = FALSE)\nNetprofit=cbind(tables1[[4]],tables1[[5]]) #净利润\nProfitability=tables1[[6]]  #盈利能力\nrepay=tables1[[7]]      #偿还能力\ngrowth=tables1[[8]]     #成长能力\noperation=tables1[[9]]  #营运能力\n#财务报表摘要\nurl2 <-'http://quotes.money.163.com/f10/cwbbzy_600000.html#01c04' \ntables2 <- readHTMLTable(url2,stringsAsFactors = FALSE)\nsummary_finance=cbind(tables2[[4]][-1,1],tables2[[5]]) #财务报表摘要\ncolnames(summary_finance)[1]=\"报告日期\"\n\n#资产负债表\nurl3 <-'http://quotes.money.163.com/f10/zcfzb_600000.html#01c05' \ntables3 <- readHTMLTable(url3,stringsAsFactors = FALSE)\nbalance=cbind(tables3[[4]][-1,1],tables3[[5]]) #资产负债表\ncolnames(balance)[1]=\"报告日期\"\n\n\n#利润表\nurl4 <-'http://quotes.money.163.com/f10/zcfzb_600000.html#01c06' \ntables4 <- readHTMLTable(url3,stringsAsFactors = FALSE)\nprofit=cbind(tables4[[4]][-1,1],tables4[[5]]) #利润表\ncolnames(profit)[1]=\"报告日期\"\n\n#现金流量表\nurl5 <-'http://quotes.money.163.com/f10/zcfzb_600000.html#01c07' \ntables5 <- readHTMLTable(url3,stringsAsFactors = FALSE)\ncash=cbind(tables5[[4]][-1,1],tables5[[5]]) #现金流量表\ncolnames(cash)[1]=\"报告日期\"\n\n\n\n#使用quantmod包\nload(\"Compangy.RData\")\ngushi=new.env()\nlibrary(quantmod)\n\nstock_list=list()\nfor( i in 1:nrow(Company)){\n  stock_list[[i]]=getSymbols(Symbols = Company$ID.SS_SZ[i],env = gushi,warnings = F,\n             src = \"yahoo\",from=\"2014-07-01\",to=\"2014-12-26\") \n  names(stock_list)[i]=Company$ID.SS_SZ[i]\n}\n\n\n########################################################################\n#读取各只股票历史股价,判断“消灭低价股”##################################\n#######################################################\n#读入沪深两市所有上市公司名称及其股票代码。\nload(\"Company.RData\")\nlibrary(XML)\nrequire(RCurl)\ntmp=data.frame(matrix(NA,ncol=2,nrow=nrow(Company)))  #存储各只股票历史股价，（股票、代码、时间1、时间2）\nreadTable  <- function (url,myheader){\n  force(url)\n  webpage <- getURL(url,httpheader = myheader,.encoding='utf-8');\n  pagetree <- htmlTreeParse(webpage,encoding=\"utf-8\", error=function(...){}, useInternalNodes = TRUE,trim=F) \n  table  <- readHTMLTable(pagetree,header = F)\n  table  <- table$FundHoldSharesTable[-c(1,2),]\n  if(length(table)!=0){\n    n  <- nrow(table)\n    table[rev(1:n),]\n  }else{\n    table=data.frame(matrix(0,nrow=30,ncol=7))\n    names(table)=paste(\"V\",1:7,sep=\"\")\n  }\n  return(table)\n}\n\nmyheader=c(\"User-Agent\"=\"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.1.6) \",\n           \"Accept\"=\"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n           \"Accept-Language\"=\"en-us\",\n           \"Connection\"=\"keep-alive\",\n           \"Accept-Charset\"=\"GB2312,utf-8;q=0.7,*;q=0.7\")\n\n\n#for( i in 1:nrow(Company)){\nn=0  #当n达到200次后，存储数据并清空下数据\na=c(1:nrow(Company))\nyear=2014\njidu=3\nfor( i in a){\n  url=\"http://vip.stock.finance.sina.com.cn/corp/go.php/vMS_MarketHistory/stockid/\"\n  url=paste(url,Company$ID[i],\".phtml?year=\",year,\"&jidu=\",jidu,sep=\"\");\n  table<- readTable (url=url,myheader=myheader)\n  table$V4=as.numeric(as.character(table$V4))\n  jiage1=table[1,4]\n  jiage2=table[nrow(table),4]\n  tmp[i,]=c(jiage1,jiage2)\n  n=n+1\n  if(n>=200){\n    save.image(paste(a[1],\"~\",i,\".RData\",sep=\"\"))\n    gc()\n    n=0\n  }\n}\n#合并股票名单和不同时期的股票价格\nstock1=cbind(Company,tmp)\nstock1=na.omit(stock1)\nnames(stock)[5:6]=paste(\"V\",1:2,sep=\"\")\n\n#挑选低价股票\nstock$seg=cut(stock$V2,breaks = seq(1,100,1))\nstock$add=(stock$V1-stock$V2)/stock$V2\nlibrary(plyr)\ntemp=ddply(stock,.variables = .(seg),summarize,mean=mean(add),nrow=length(add))\nlibrary(ggplot2)\nggplot(temp,aes(seg,mean,group=1))+geom_point()+geom_line()\n\n\n#################################################################################\n#读取各只股票，查找各自股票的分红、拆股历史数据##################################\nload(\"Company.RData\")\nlibrary(XML)\n#url=\"http://quotes.money.163.com/f10/fhpg_600000.html#01d05\"\nurl=\"http://quotes.money.163.com/f10/fhpg_\"\nID=Company$ID\nurl=paste(url,ID,\".html#01d05\",sep=\"\")\ntable <- readHTMLTable(url,stringsAsFactors = FALSE)[[4]]\nnames(table)=c(\"公告日期\",\"分红年度\",\"送股\",\"转增\",\"派息\",\"股权登记日\",\"除权除息日\",\"红股上市日\")\ntable=table[-c(1,2),]\ntable$公告日期=as.Date(table$公告日期)\ntable=table[table$公告日期>=as.Date(\"2008-01-01\"),]\n\nlibrary(quantmod)\ngushi=new.env()\nfor(i in 1:nrow(Company)){\n  url1=\"http://ichart.finance.yahoo.com/table.csv?s=\"\n  url2=\"&a=0&b=01&c=2007&d=0&e=05&f=2015&g=d&q=q&y=0&z=\"\n  url=paste(url1,Company$ID.SS_SZ[i],url2,Company$ID.SS_SZ[i],\"&x=.csv\",sep=\"\")\n  readUrl(url)\n}\n  \n  \nfor(i in 1:5){\n  tryCatch(getSymbols(Symbols = Company$ID.SS_SZ[i],src = \"yahoo\"),\n           error=function(Symbols){message(paste(\"ID does not seem to exist:\", ID))})\n}\n\ntemp=as.data.frame(get(Compangy$ID.SS_SZ))\n\ntemp$day=index(get(Compangy$ID.SS_SZ))\ncolnames(temp)=c('open','high','low','close','volume','adjusted','day')\ntmp=temp[which(temp$day %in% as.Date(table$除权除息日)),]\ntmp=tmp[order(tmp$day,decreasing = T),]\nas.numeric(table$派息)/tmp$close/10\n\n\n\n",
    "created" : 1446623529862.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3938048378",
    "id" : "6047F5CF",
    "lastKnownWriteTime" : 1420428260,
    "path" : "D:/Rwork/stock.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}